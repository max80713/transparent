import{Z as K,D as p,a as X,V as ae,C as z,v as U,b as ie,F as g,B as f,H as T,j as W,c as m,l as x,G as ee,q,d as Y,W as V,$ as Q,e as te,f as se,i as A,x as H,g as $,h as Z,k as le,N as B,s as J,A as ne,m as oe}from"./index-CJDM78fZ.js";var ce=Object.defineProperty,he=(L,e,s)=>e in L?ce(L,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):L[e]=s,u=(L,e,s)=>he(L,typeof e!="symbol"?e+"":e,s);class pe{constructor(e){u(this,"vNodes"),u(this,"thread"),u(this,"serviceWorkShapes",new Map),u(this,"localWorkShapes",new Map),u(this,"tmpOpt"),u(this,"animationId"),u(this,"syncUnitTime",z.syncOpt.interval),this.vNodes=e.vNodes,this.thread=e.thread}createLocalWork(e){const{workId:s,opt:t,toolsType:r}=e;if(s&&t){const o=s.toString();!this.getToolsOpt()&&r&&this.setToolsOpt({toolsType:r,toolsOpt:t}),this.setWorkOptions(o,t)}}getLocalWorkShape(e){return this.localWorkShapes.get(e)}createLocalWorkShape(e,s){if(e&&this.tmpOpt){const t={toolsType:this.tmpOpt.toolsType,toolsOpt:s||this.tmpOpt.toolsOpt},r=this.createWorkShapeNode({...t,workId:e});return r&&this.localWorkShapes.set(e,{node:r,toolsType:r.toolsType,workState:W.Start}),r}}canUseTopLayer(e){return e===m.LaserPen}destroy(){this.clearAll()}clearAll(){this.thread.topLayer.children.length&&(this.thread.topLayer.parent.children.forEach(e=>{e.name!=="viewport"&&e.remove()}),q(this.thread.serviceLayer,this.thread.serviceLayer.parent)),this.serviceWorkShapes.clear(),this.localWorkShapes.clear()}consumeDraw(e){const{workId:s,dataType:t}=e;if(t===f.Service)this.activeServiceWorkShape(e);else{const r=s==null?void 0:s.toString(),o=r&&this.localWorkShapes.get(r);if(!o)return;const a=o.node.consume({data:e,isFullWork:!1,isSubWorker:!0});a.rect&&(o.result=a,o.workState=W.Doing,r&&this.localWorkShapes.set(r,o))}this.runAnimation()}setToolsOpt(e){var s;this.tmpOpt=e,(s=e.toolsOpt)!=null&&s.syncUnitTime&&(this.syncUnitTime=e.toolsOpt.syncUnitTime)}getToolsOpt(){return this.tmpOpt}createWorkShapeNode(e){const{toolsType:s}=e;if(s===m.LaserPen)return H({...e,vNodes:this.vNodes,fullLayer:this.thread.topLayer,drawLayer:this.thread.topLayer})}setNodeKey(e,s,t,r){return s.toolsType=t,s.node=this.createWorkShapeNode({workId:e,toolsType:t,toolsOpt:r}),s}activeServiceWorkShape(e){var s,t;const{workId:r,opt:o,toolsType:a,type:i,updateNodeOpt:l,ops:n,op:c}=e;if(!r)return;const h=r.toString(),k=(s=this.vNodes.get(h))==null?void 0:s.rect;if(!((t=this.serviceWorkShapes)!=null&&t.has(h))){let y={toolsType:a,animationWorkData:c||[],animationIndex:0,type:i,updateNodeOpt:l,ops:n,oldRect:k};a&&o&&(y=this.setNodeKey(h,y,a,o)),this.serviceWorkShapes.set(h,y)}const d=this.serviceWorkShapes.get(h);i&&(d.type=i),n&&(d.animationWorkData=$(n),d.ops=n),l&&(d.updateNodeOpt=l),c&&(d.animationWorkData=c),d.node&&d.node.getWorkId()!==h&&d.node.setWorkId(h),k&&(d.oldRect=k),a&&o&&(d.toolsType!==a&&a&&o&&this.setNodeKey(h,d,a,o),d.node&&d.node.setWorkOptions(o))}computNextAnimationIndex(e,s){var t;const r=((t=e.node)==null?void 0:t.syncUnitTime)||this.syncUnitTime,o=Math.floor((e.animationWorkData||[]).slice(e.animationIndex).length*32/s/r)*s;return Math.min((e.animationIndex||0)+(o||s),(e.animationWorkData||[]).length)}animationDraw(){var e,s,t,r;this.animationId=void 0;let o=!1;const a=new Map,i=[];for(const[l,n]of this.serviceWorkShapes.entries())switch(n.toolsType){case m.LaserPen:{const c=this.computNextAnimationIndex(n,8),h=Math.max(0,n.animationIndex||0),k=(n.animationWorkData||[]).slice(h,c);if((n.animationIndex||0)<c&&((e=n.node)==null||e.consumeService({op:k,isFullWork:!1}),n.animationIndex=c,k.length&&a.set(l,{workState:h===0?W.Start:c===((s=n.animationWorkData)==null?void 0:s.length)?W.Done:W.Doing,op:k.slice(-2)})),n.isDel){(t=n.node)==null||t.clearTmpPoints(),this.serviceWorkShapes.delete(l);break}n.ops&&n.animationIndex===((r=n.animationWorkData)==null?void 0:r.length)&&!n.isDel&&(this.thread.topLayer.getElementsByName(l.toString())[0]||(n.isDel=!0,this.serviceWorkShapes.set(l,n))),o=!0;break}}for(const[l,n]of this.localWorkShapes.entries()){const{result:c,toolsType:h,isDel:k,workState:d}=n;switch(h){case m.LaserPen:{if(k){n.node.clearTmpPoints(),this.localWorkShapes.delete(l),i.push({removeIds:[l.toString()],type:p.RemoveNode});break}c&&((c.op||c.ops)&&i.push(c),n.result=void 0),!this.thread.topLayer.getElementsByName(l.toString())[0]&&d===W.Done&&(n.isDel=!0,this.localWorkShapes.set(l,n)),o=!0;break}}}o&&this.runAnimation(),a.size&&a.forEach((l,n)=>{i.push({type:p.Cursor,uid:n.split(oe)[0],op:l.op,workState:l.workState,viewId:this.thread.viewId})}),i.length&&this.thread.post({sp:i})}runAnimation(){this.animationId||(this.animationId=requestAnimationFrame(this.animationDraw.bind(this)))}setWorkOptions(e,s){var t;let r=(t=this.localWorkShapes.get(e))==null?void 0:t.node;if(!r&&this.tmpOpt){const{toolsType:o}=this.tmpOpt;this.tmpOpt.toolsOpt=s,r=this.createWorkShapeNode({workId:e,toolsType:o,toolsOpt:s}),r&&this.localWorkShapes.set(e,{node:r,toolsType:o,workState:W.Start}),this.setToolsOpt(this.tmpOpt)}s!=null&&s.syncUnitTime||(s.syncUnitTime=this.syncUnitTime),r&&r.setWorkOptions(s)}consumeDrawAll(e){const{workId:s,dataType:t}=e;if(t===f.Service)this.activeServiceWorkShape(e);else{const r=s==null?void 0:s.toString(),o=r&&this.localWorkShapes.get(r);if(!o)return;const a=o.node.consumeAll({data:e});o.result=a,o.workState=W.Done,r&&this.localWorkShapes.set(r,o)}this.runAnimation()}}class de{constructor(e){u(this,"vNodes"),u(this,"thread"),u(this,"workShapes",new Map),u(this,"effectSelectNodeData",new Set),u(this,"batchEraserRemoveNodes",new Set),u(this,"batchEraserWorks",new Set),u(this,"tmpOpt"),u(this,"syncUnitTime",z.syncOpt.interval),u(this,"fullWorkerDrawCount",0),u(this,"drawWorkActiveId"),u(this,"consumeCount",0),this.vNodes=e.vNodes,this.thread=e.thread}async loadImageBitMap(e){return await this.thread.loadImageBitMap(e)}createLocalWork(e){const{workId:s,opt:t,toolsType:r}=e;if(s&&t){const o=s.toString();!this.getToolsOpt()&&r&&this.setToolsOpt({toolsType:r,toolsOpt:t}),this.setWorkOptions(o,t)}}async updateSelector(e){var s;const t=this.workShapes.get(T);if(!((s=t==null?void 0:t.selectIds)!=null&&s.length))return;const{callback:r,...o}=e,{updateSelectorOpt:a,willSerializeData:i}=o,l=await(t==null?void 0:t.updateSelector({updateSelectorOpt:a,selectIds:x.cloneDeep(t.selectIds),vNodes:this.vNodes,willSerializeData:i,worker:this})),n=new Map;let c;l!=null&&l.selectIds&&(c=x.xor(t.selectIds,l.selectIds),l.selectIds.forEach(d=>{const y=this.vNodes.get(d);if(y){const{toolsType:v,op:I,opt:w}=y;n.set(d,{opt:w,toolsType:v,ops:(I==null?void 0:I.length)&&J(I)||void 0})}}),t.selectIds=l.selectIds);const h=[],k=r&&r({res:l,workShapeNode:t,param:o,postData:{sp:h},newServiceStore:n})||{sp:h};c&&k.sp.push({type:p.RemoveNode,removeIds:c,viewId:this.thread.viewId}),k.sp.length&&this.thread.post(k)}destroy(){this.clearAll()}clearAll(){if(this.thread.localLayer.children.length&&(this.thread.topLayer.parent.children.forEach(e=>{e.name!=="viewport"&&e.remove()}),q(this.thread.localLayer,this.thread.localLayer.parent)),this.workShapes.get(T)){const e=[];e.push({type:p.Select,dataType:f.Local,selectIds:[],willSyncService:!1}),this.thread.post({sp:e})}this.workShapes.clear(),this.effectSelectNodeData.clear(),this.batchEraserWorks.clear(),this.batchEraserRemoveNodes.clear()}async checkTextActive(e){const{op:s,viewId:t,dataType:r}=e;if(s!=null&&s.length){let o;for(const a of this.vNodes.curNodeMap.values()){const{rect:i,name:l,toolsType:n,opt:c}=a,h=s[0]*this.thread.fullLayer.worldScaling[0]+this.thread.fullLayer.worldPosition[0],k=s[1]*this.thread.fullLayer.worldScaling[1]+this.thread.fullLayer.worldPosition[1];if(n===m.Text&&ne([h,k],i)&&c.workState===W.Done){o=l;break}}o&&(await this.blurSelector({viewId:t,msgType:p.Select,dataType:r,isSync:!0}),this.thread.post({sp:[{type:p.GetTextActive,toolsType:m.Text,workId:o}]}))}}cursorHover(e){const{opt:s,toolsType:t,point:r}=e,o=this.setFullWork({workId:B,toolsType:t,opt:s});o&&r&&o.cursorHover(r)}cursorBlur(){var e;const s=this.getWorkShape(B);s&&(e=s.selectIds)!=null&&e.length&&(s.cursorBlur(),this.clearWorkShapeNodeCache(B)),this.thread.fullLayer.parent.children.forEach(t=>{t.name==="Cursor_Hover_Id"&&t.remove()})}updateFullSelectWork(e){var s,t,r,o,a;const i=this.workShapes.get(T),{selectIds:l}=e;if(!(l!=null&&l.length)){this.blurSelector(e);return}if(!i){const n=this.setFullWork(e);!n&&e.workId&&this.tmpOpt&&((s=this.tmpOpt)==null?void 0:s.toolsType)===m.Selector&&this.setWorkOptions(e.workId.toString(),e.opt||this.tmpOpt.toolsOpt),n&&this.updateFullSelectWork(e);return}if(i&&l!=null&&l.length){const{selectRect:n}=i.updateSelectIds(l),c=[{...e,selectorColor:((t=e.opt)==null?void 0:t.strokeColor)||i.selectorColor,strokeColor:((r=e.opt)==null?void 0:r.strokeColor)||i.strokeColor,fillColor:((o=e.opt)==null?void 0:o.fillColor)||i.fillColor,textOpt:((a=e.opt)==null?void 0:a.textOpt)||i.textOpt,canTextEdit:i.canTextEdit,canRotate:i.canRotate,scaleType:i.scaleType,type:p.Select,selectRect:n,points:i.getChildrenPoints(),willSyncService:(e==null?void 0:e.willSyncService)||!1,opt:(e==null?void 0:e.willSyncService)&&i.getWorkOptions()||void 0,canLock:i.canLock,isLocked:i.isLocked,toolsTypes:i.toolsTypes,shapeOpt:i.shapeOpt,thickness:i.thickness,useStroke:i.useStroke,strokeType:i.strokeType}];this.thread.post({sp:c})}}commandDeleteText(e){const s=this.vNodes.get(e);if(s&&s.toolsType===m.Text)return{type:p.TextUpdate,toolsType:m.Text,workId:e,dataType:f.Local}}async removeSelector(e){const{willSyncService:s}=e,t=[],r=[],o=this.workShapes.get(T);if(!o)return;const a=o.selectIds&&[...o.selectIds]||[];for(const i of a){if(this.vNodes.get(i)){const l=this.commandDeleteText(i);l&&t.push(l)}this.removeNode(i),r.push(i)}r.length&&t.push({type:p.RemoveNode,removeIds:r}),t.push({type:p.Select,selectIds:[],willSyncService:s}),await this.blurSelector(),t.length&&this.thread.post({sp:t})}removeWork(e){const{workId:s}=e,t=s==null?void 0:s.toString();t&&this.removeNode(t)}removeNode(e){var s;this.vNodes.get(e)&&((s=this.thread.fullLayer)==null||s.getElementsByName(e).forEach(t=>{t.remove(),A(t,this.thread.fullLayer.parent)}),this.vNodes.delete(e)),this.workShapes.has(e)&&(this.thread.localLayer.getElementsByName(e).forEach(t=>{t.remove(),A(t,this.thread.localLayer.parent)}),this.clearWorkShapeNodeCache(e))}setFullWork(e){const{workId:s,opt:t,toolsType:r}=e;if(s&&t&&r){const o=s.toString();let a;return s&&this.workShapes.has(o)?(a=this.workShapes.get(o),a==null||a.setWorkOptions(t)):a=this.createWorkShapeNode({toolsOpt:t,toolsType:r,workId:o}),a?(this.workShapes.set(o,a),a):void 0}}async consumeFull(e){var s;const t=this.setFullWork(e),r=e.ops&&$(e.ops);if(t){const o=(s=e.workId)==null?void 0:s.toString();t.toolsType===m.Image?await t.consumeServiceAsync({isFullWork:!0,replaceId:o,worker:this}):t.toolsType===m.Text?await t.consumeServiceAsync({isFullWork:!0,replaceId:o}):t.consumeService({op:r,isFullWork:!0,replaceId:o}),e!=null&&e.updateNodeOpt&&t.updataOptService(e.updateNodeOpt);const a=[];e.workId&&this.workShapes.delete(e.workId.toString()),e.willSyncService&&a.push({opt:e.opt,toolsType:e.toolsType,type:p.FullWork,workId:e.workId,ops:e.ops,updateNodeOpt:e.updateNodeOpt,viewId:this.thread.viewId}),a.length&&this.thread.post({sp:a})}}async colloctEffectSelectWork(e){const s=this.workShapes.get(T),{workId:t,msgType:r}=e;if(s&&t&&s.selectIds&&s.selectIds.includes(t.toString())){r===p.RemoveNode?s.selectIds=s.selectIds.filter(o=>o!==t.toString()):this.effectSelectNodeData.add(e),await new Promise(o=>{setTimeout(()=>{o(!0)},0)}),await this.runEffectSelectWork(!0).then(()=>{var o;(o=this.effectSelectNodeData)==null||o.clear()});return}return e}async runEffectSelectWork(e){var s;for(const t of this.effectSelectNodeData.values()){const r=this.setFullWork(t);if(r){const o=(s=t.workId)==null?void 0:s.toString();if(r.toolsType===m.Image)await r.consumeServiceAsync({isFullWork:!0,replaceId:o,worker:this});else if(r.toolsType===m.Text)await r.consumeServiceAsync({isFullWork:!0,replaceId:o});else{const a=t.ops&&$(t.ops);r.consumeService({op:a,isFullWork:!0,replaceId:o}),t!=null&&t.updateNodeOpt&&r.updataOptService(t.updateNodeOpt)}t.workId&&this.workShapes.delete(t.workId.toString())}}this.reRenderSelector(e)}hasSelector(){return this.workShapes.has(T)}getSelector(){return this.workShapes.get(T)}reRenderSelector(e=!1){var s;const t=this.workShapes.get(T);if(!t)return;if(t&&!((s=t.selectIds)!=null&&s.length))return this.blurSelector();const r=t.reRenderSelector();r&&this.thread.post({sp:[{type:p.Select,selectIds:t.selectIds,selectRect:r,willSyncService:e,viewId:this.thread.viewId,points:t.getChildrenPoints(),textOpt:t.textOpt,selectorColor:t.selectorColor,strokeColor:t.strokeColor,fillColor:t.fillColor,canTextEdit:t.canTextEdit,canRotate:t.canRotate,scaleType:t.scaleType,opt:t.getWorkOptions()||void 0,canLock:t.canLock,isLocked:t.isLocked,toolsTypes:t.toolsTypes,shapeOpt:t.shapeOpt,thickness:t.thickness,useStroke:t.useStroke,strokeType:t.strokeType}]})}async blurSelector(e){var s;const t=this.workShapes.get(T),r=t==null?void 0:t.blurSelector();if(this.clearWorkShapeNodeCache(T),((s=this.thread.fullLayer)==null?void 0:s.parent).children.forEach(o=>{o.name===T&&o.remove()}),r){const o=[];o.push({...r,isSync:e==null?void 0:e.isSync}),this.thread.post({sp:o})}}clearWorkShapeNodeCache(e){var s;(s=this.getWorkShape(e))==null||s.clearTmpPoints(),this.workShapes.delete(e)}async drawBitMapEraserFull(e,s,t){const{willUpdateNodes:r,willDeleteNodes:o}=s,a=e.getWorkId(),i=[{type:p.RemoveNode,removeIds:[a],viewId:this.thread.viewId}];if(t&&i.push({type:p.None,isLockSentEventCursor:t}),r!=null&&r.size||o!=null&&o.size){if(r!=null&&r.size)for(const[l,n]of r)i.push({type:p.UpdateNode,dataType:f.Local,opt:n.opt,workId:l,updateNodeOpt:{useAnimation:!1}});o!=null&&o.size&&i.push({type:p.RemoveNode,removeIds:[...o],viewId:this.thread.viewId})}i.length&&this.thread.post({sp:i})}drawPencilEraserFull(e,s,t){const{willNewNodes:r,willDeleteNodes:o}=s,a=e.getWorkId(),i=[{type:p.RemoveNode,removeIds:[a],viewId:this.thread.viewId}];if(t&&i.push({type:p.None,isLockSentEventCursor:t}),r!=null&&r.size||o!=null&&o.size){if(r!=null&&r.size)for(const[l,n]of r)i.push({type:p.FullWork,dataType:f.Local,ops:J(n.op),opt:n.opt,workId:l,updateNodeOpt:{useAnimation:!1}});o!=null&&o.size&&i.push({type:p.RemoveNode,removeIds:[...o],viewId:this.thread.viewId})}i.length&&this.thread.post({sp:i})}drawEraser(e,s){const t=[];e.removeIds&&t.push(e),s&&t.push({type:p.None,isLockSentEventCursor:s}),this.thread.post({sp:t,consumeCount:this.consumeCount})}getWorkShape(e){return this.workShapes.get(e)}getWorkShapes(){return this.workShapes}consumeDraw(e,s){const{op:t,workId:r,scenePath:o,postCount:a}=e;if(t!=null&&t.length&&r){const i=r.toString(),l=this.workShapes.get(i);if(!l)return;const n=l.toolsType;if(n===m.LaserPen)return;switch(this.drawWorkActiveId&&this.drawWorkActiveId!==i&&(this.consumeDrawAll({workId:this.drawWorkActiveId,scenePath:o,viewId:this.thread.viewId,msgType:p.DrawWork,dataType:f.Local},s),this.drawWorkActiveId=void 0),!this.drawWorkActiveId&&i!==T&&(this.drawWorkActiveId=i),x.isNumber(a)&&(this.consumeCount=a),n){case m.Selector:{const c=l.consume({data:e,isFullWork:!0,isMainThread:!0});this.fullWorkerDrawCount++;const h=[];c.type===p.Select&&(c.selectIds&&s.runReverseSelectWork(c.selectIds),h.push(c)),this.thread.post({consumeCount:this.consumeCount,fullWorkerDrawCount:this.fullWorkerDrawCount,sp:h})}break;case m.PencilEraser:case m.BitMapEraser:{const c=l.consume({data:e,isFullWork:!1,isMainThread:!0});this.fullWorkerDrawCount++,this.thread.post({consumeCount:this.consumeCount,fullWorkerDrawCount:this.fullWorkerDrawCount,sp:c.op&&[{...c,scenePath:o}]||void 0});break}case m.Eraser:{const c=l.consume({data:e,isFullWork:!0});this.drawEraser(c)}break;case m.Arrow:case m.Straight:case m.Ellipse:case m.Rectangle:case m.Star:case m.Polygon:case m.SpeechBalloon:case m.Pencil:{const c=l.consume({data:e,isFullWork:!1,isMainThread:!0});c&&(this.fullWorkerDrawCount++,this.thread.post({consumeCount:this.consumeCount,fullWorkerDrawCount:this.fullWorkerDrawCount,sp:c.op&&[{...c,scenePath:o}]||void 0}))}break}}}consumeDrawAll(e,s){var t,r,o;const{workId:a,scenePath:i,isLockSentEventCursor:l}=e;if(a){const n=a.toString();this.drawWorkActiveId===n&&(this.drawWorkActiveId=void 0);const c=this.workShapes.get(n);if(!c)return;const h=c.toolsType;if(h===m.LaserPen)return;const k=this.workShapes.get(B),d=(t=k==null?void 0:k.selectIds)==null?void 0:t[0],y=c.consumeAll({data:e,workerEngine:this});switch(h){case m.Selector:{y.selectIds&&d&&(r=y.selectIds)!=null&&r.includes(d)&&k.cursorBlur();const v=[];l&&v.push({type:p.None,isLockSentEventCursor:l}),y.type===p.Select&&(y.selectIds&&s.runReverseSelectWork(y.selectIds),v.push({...y,scenePath:i})),v.length&&this.thread.post({sp:v}),(o=c.selectIds)!=null&&o.length?c.clearTmpPoints():this.clearWorkShapeNodeCache(n)}break;case m.PencilEraser:this.drawPencilEraserFull(c,y,l),this.fullWorkerDrawCount=0,this.clearWorkShapeNodeCache(n);break;case m.BitMapEraser:this.drawBitMapEraserFull(c,y,l),this.fullWorkerDrawCount=0,this.clearWorkShapeNodeCache(n);break;case m.Eraser:this.drawEraser({...y,scenePath:i},l),c.clearTmpPoints();break;case m.Arrow:case m.Straight:case m.Ellipse:case m.Rectangle:case m.Star:case m.Polygon:case m.SpeechBalloon:case m.Pencil:{const v=[];l&&v.push({type:p.None,isLockSentEventCursor:l}),y&&(v.push(y),this.fullWorkerDrawCount=0,this.thread.post({fullWorkerDrawCount:this.fullWorkerDrawCount,sp:v})),this.clearWorkShapeNodeCache(n);break}}}}getToolsOpt(){return this.tmpOpt}setToolsOpt(e){var s;this.tmpOpt=e,(s=e.toolsOpt)!=null&&s.syncUnitTime&&(this.syncUnitTime=e.toolsOpt.syncUnitTime)}setWorkOptions(e,s){let t=this.workShapes.get(e);if(!t&&this.tmpOpt){const{toolsType:r}=this.tmpOpt;this.tmpOpt.toolsOpt=s,t=this.createWorkShapeNode({workId:e,toolsType:r,toolsOpt:s}),t&&this.workShapes.set(e,t),this.setToolsOpt(this.tmpOpt)}s.syncUnitTime||(s.syncUnitTime=this.syncUnitTime),t==null||t.setWorkOptions(s)}createWorkShapeNode(e){return H({...e,vNodes:this.vNodes,fullLayer:this.thread.fullLayer,drawLayer:this.thread.localLayer},this.thread.serviceWork)}}class ue{constructor(e){u(this,"vNodes"),u(this,"thread"),u(this,"workShapes",new Map),u(this,"selectorWorkShapes",new Map),u(this,"willRunEffectSelectorIds",new Set),u(this,"runEffectId"),u(this,"animationId"),u(this,"syncUnitTime",z.syncOpt.interval),this.vNodes=e.vNodes,this.thread=e.thread}async loadImageBitMap(e){return await this.thread.loadImageBitMap(e)}destroy(){this.clearAll()}clearAll(){this.thread.serviceLayer.children.length&&(this.thread.serviceLayer.parent.children.forEach(e=>{e.name!=="viewport"&&e.remove()}),q(this.thread.serviceLayer,this.thread.serviceLayer.parent)),this.workShapes.clear(),this.selectorWorkShapes.clear(),this.willRunEffectSelectorIds.clear()}runEffect(){this.runEffectId||(this.runEffectId=setTimeout(this.effectRunSelector.bind(this),0))}effectRunSelector(){this.runEffectId=void 0,this.willRunEffectSelectorIds.forEach(e=>{var s,t;const r=this.selectorWorkShapes.get(e);r&&r.selectIds&&((s=r.node)==null||s.selectServiceNode(e,r,!0)),(t=r==null?void 0:r.selectIds)!=null&&t.length||this.selectorWorkShapes.delete(e)}),this.willRunEffectSelectorIds.clear()}runSelectWork(e){this.activeSelectorShape(e);const{workId:s}=e,t=s==null?void 0:s.toString();t&&this.willRunEffectSelectorIds.add(t),this.runEffect()}removeWork(e){const{workId:s}=e,t=s==null?void 0:s.toString();if(t){if(this.workShapes.get(t)){this.workShapes.delete(t),this.removeNode(t,e);return}this.removeNode(t,e)}}consumeFull(e){this.activeWorkShape(e),this.runAnimation()}runReverseSelectWork(e){e.forEach(s=>{this.selectorWorkShapes.forEach((t,r)=>{var o;if((o=t.selectIds)!=null&&o.length){const a=t.selectIds.indexOf(s);a>-1&&(t.selectIds.splice(a,1),this.willRunEffectSelectorIds.add(r))}})}),this.willRunEffectSelectorIds.size&&this.runEffect()}consumeDraw(e){this.activeWorkShape(e),this.runAnimation()}computNextAnimationIndex(e,s){const t=Math.floor((e.animationWorkData||[]).slice(e.animationIndex).length*32/s/this.syncUnitTime)*s;return Math.min((e.animationIndex||0)+(t||s),(e.animationWorkData||[]).length)}async animationDraw(){var e,s,t,r,o,a,i,l,n,c,h,k,d,y,v,I,w,b,F;this.animationId=void 0;let j=!1;const M=new Map;for(const[C,S]of this.workShapes.entries())switch(S.toolsType){case m.Image:{await((e=S.node)==null?void 0:e.consumeServiceAsync({isFullWork:!0,worker:this})),this.selectorWorkShapes.forEach((N,D)=>{var O;(O=N.selectIds)!=null&&O.includes(C)&&(this.willRunEffectSelectorIds.add(D),this.runEffect())}),this.workShapes.delete(C);break}case m.Text:{S.node&&(await((s=S.node)==null?void 0:s.consumeServiceAsync({isFullWork:!0,replaceId:C})),this.selectorWorkShapes.forEach((N,D)=>{var O;(O=N.selectIds)!=null&&O.includes(C)&&(this.willRunEffectSelectorIds.add(D),this.runEffect())}),(t=S.node)==null||t.clearTmpPoints(),this.workShapes.delete(C));break}case m.Arrow:case m.Straight:case m.Rectangle:case m.Ellipse:case m.Star:case m.Polygon:case m.SpeechBalloon:{const N=!!S.ops;if((r=S.animationWorkData)!=null&&r.length){const D=S.oldRect;(o=S.node)==null||o.consumeService({op:S.animationWorkData,isFullWork:N}),N&&(this.selectorWorkShapes.forEach((O,R)=>{var P;(P=O.selectIds)!=null&&P.includes(C)&&(this.willRunEffectSelectorIds.add(R),this.runEffect())}),(a=S.node)==null||a.clearTmpPoints(),this.workShapes.delete(C)),M.set(C,{workState:D?S.ops?W.Done:W.Doing:W.Start,op:S.animationWorkData.filter((O,R)=>{if(R%3!==2)return!0}).slice(-2)}),S.animationWorkData.length=0}break}case m.Pencil:{if(!S.useAnimation&&S.ops)(i=S.node)==null||i.consumeService({op:S.animationWorkData||[],isFullWork:!0,replaceId:C}),(l=S.node)==null||l.updataOptService(S.updateNodeOpt),this.selectorWorkShapes.forEach((N,D)=>{var O;(O=N.selectIds)!=null&&O.includes(C)&&(this.willRunEffectSelectorIds.add(D),this.runEffect())}),(n=S.node)==null||n.clearTmpPoints(),this.workShapes.delete(C);else if(S.useAnimation){if(S.isDel){(c=S.node)==null||c.clearTmpPoints(),this.workShapes.delete(C);break}const N=3,D=this.computNextAnimationIndex(S,N),O=S.isDiff?0:Math.max(0,(S.animationIndex||0)-N),R=(S.animationWorkData||[]).slice(O,D),P=(k=(h=S.node)==null?void 0:h.getWorkId())==null?void 0:k.toString();if((S.animationIndex||0)<D||S.isDiff){if((d=S.node)==null||d.consumeService({op:R,isFullWork:!1}),S.animationIndex=D,S.isDiff&&(S.isDiff=!1),R.length){const G=R.filter((_,re)=>{if(re%N!==N-1)return!0}).slice(-2);M.set(C,{workState:O===0?W.Start:D===((y=S.animationWorkData)==null?void 0:y.length)?W.Done:W.Doing,op:G})}}else S.ops&&((v=S.node)==null||v.consumeService({op:S.animationWorkData||[],isFullWork:!0,replaceId:P}),S.isDel=!0,M.set(C,{workState:W.Done,op:R.filter((G,_)=>{if(_%N!==N-1)return!0}).slice(-2)}));j=!0;break}break}case m.BitMapEraser:case m.PencilEraser:{if(S.isDel){(I=S.node)==null||I.clearTmpPoints(),this.workShapes.delete(C);break}if(S.ops&&(w=S.animationWorkData)!=null&&w.length){const N=S.animationWorkData.slice(-3,-1);M.set(C,{workState:W.Done,op:N}),S.isDel=!0;break}if(S.useAnimation){const N=this.computNextAnimationIndex(S,3),D=S.isDiff?0:Math.max(0,(S.animationIndex||0)-3),O=(S.animationWorkData||[]).slice(D,N);if(((S.animationIndex||0)<N||S.isDiff)&&((b=S.node)==null||b.consumeService({op:O,isFullWork:!1}),S.animationIndex=N,S.isDiff&&(S.isDiff=!1),O.length)){const R=O.filter((P,G)=>{if(G%3!==2)return!0}).slice(-2);M.set(C,{workState:D===0?W.Start:N===((F=S.animationWorkData)==null?void 0:F.length)?W.Done:W.Doing,op:R})}j=!0;break}break}}if(j&&this.runAnimation(),M.size){const C=[];M.forEach((S,N)=>{C.push({type:p.Cursor,uid:N.split(oe)[0],op:S.op,workState:S.workState,viewId:this.thread.viewId})}),this.thread.post({sp:C})}}runAnimation(){this.animationId||(this.animationId=requestAnimationFrame(this.animationDraw.bind(this)))}hasDiffData(e,s,t){const r=e.length;if(s.length<r)return!0;switch(t){case m.Pencil:{for(let o=0;o<r;o+=3)if(s[o]!==e[o]||s[o+1]!==e[o+1])return!0;break}case m.LaserPen:{for(let o=0;o<r;o+=2)if(s[o]!==e[o]||s[o+1]!==e[o+1])return!0;break}}return!1}activeWorkShape(e){var s,t,r,o;const{workId:a,opt:i,toolsType:l,type:n,updateNodeOpt:c,ops:h,op:k,useAnimation:d,imageBitmap:y}=e;if(!a)return;const v=a.toString(),I=(s=this.vNodes.get(v))==null?void 0:s.rect;if(!((t=this.workShapes)!=null&&t.has(v))){let b={toolsType:l,animationWorkData:k||[],animationIndex:0,type:n,updateNodeOpt:c,ops:h,useAnimation:typeof d<"u"?d:typeof(c==null?void 0:c.useAnimation)<"u"?c==null?void 0:c.useAnimation:!0,oldRect:I,isDiff:!1,imageBitmap:y};l&&i&&(b=this.setNodeKey(v,b,l,i)),(r=this.workShapes)==null||r.set(v,b)}const w=(o=this.workShapes)==null?void 0:o.get(v);n&&(w.type=n),h&&(w.animationWorkData=$(h),w.ops=h),c&&(w.updateNodeOpt=c),k&&(w.isDiff=this.hasDiffData(w.animationWorkData||[],k,w.toolsType),w.animationWorkData=k),w.node&&w.node.getWorkId()!==v&&w.node.setWorkId(v),I&&(w.oldRect=I),l&&i&&(i.syncUnitTime&&(this.syncUnitTime=i.syncUnitTime),w.toolsType!==l&&l&&i&&this.setNodeKey(v,w,l,i),w.node&&w.node.setWorkOptions(i)),y&&(w.imageBitmap=y)}removeNode(e,s){e.indexOf(T)>-1&&this.removeSelectWork(s),this.thread.fullLayer.getElementsByName(e).forEach(t=>{t.remove(),A(t,this.thread.fullLayer.parent)}),this.thread.serviceLayer.getElementsByName(e).forEach(t=>{t.remove(),A(t,this.thread.serviceLayer.parent)}),this.vNodes.delete(e)}removeSelectWork(e){const{workId:s}=e,t=s==null?void 0:s.toString();t&&(this.activeSelectorShape(e),this.willRunEffectSelectorIds.add(t)),this.runEffect()}activeSelectorShape(e){var s,t,r;const{workId:o,opt:a,toolsType:i,type:l,selectIds:n}=e;if(!o)return;const c=o.toString();if(!((s=this.selectorWorkShapes)!=null&&s.has(c))){let k={toolsType:i,selectIds:n,type:l,opt:a};i&&a&&(k=this.setNodeKey(c,k,i,a)),(t=this.selectorWorkShapes)==null||t.set(c,k)}const h=(r=this.selectorWorkShapes)==null?void 0:r.get(c);l&&(h.type=l),h.node&&h.node.getWorkId()!==c&&h.node.setWorkId(c),h.selectIds=n||[]}setNodeKey(e,s,t,r){return s.toolsType=t,s.node=H({toolsType:t,toolsOpt:r,vNodes:this.vNodes,fullLayer:this.thread.fullLayer,drawLayer:this.thread.serviceLayer,workId:e},this),s}}class E{constructor(){u(this,"localWork"),u(this,"serviceWork"),u(this,"threadEngine")}registerMainThread(e){return this.threadEngine=e,this.localWork=e.localWork,this.serviceWork=e.serviceWork,this}}class me extends E{constructor(){super(...arguments),u(this,"emitEventType",g.CopyNode)}async consume(e){const{msgType:s,dataType:t,emitEventType:r}=e;if(s===p.FullWork&&t===f.Local&&r===this.emitEventType)return this.consumeForLocalWorker(e),!0}async consumeForLocalWorker(e){var s;const{workId:t}=e;t&&await((s=this.localWork)==null?void 0:s.consumeFull(e))}}class ke extends E{constructor(){super(...arguments),u(this,"emitEventType",g.SetColorNode)}async consume(e){const{msgType:s,dataType:t,emitEventType:r}=e;if(s===p.UpdateNode&&t===f.Local&&r===this.emitEventType)return this.consumeForLocalWorker(e),!0}async consumeForLocalWorker(e){var s;const{workId:t,updateNodeOpt:r,willRefreshSelector:o,willSyncService:a,willSerializeData:i,textUpdateForWoker:l}=e;t===T&&r&&await((s=this.localWork)==null?void 0:s.updateSelector({updateSelectorOpt:r,willRefreshSelector:o,willSyncService:a,willSerializeData:i,textUpdateForWoker:l,callback:this.updateSelectorCallback}))}updateSelectorCallback(e){const{param:s,postData:t,newServiceStore:r}=e,{willSyncService:o,isSync:a,textUpdateForWoker:i}=s,l=t.sp||[];if(o)for(const[n,c]of r.entries())i&&c.toolsType===m.Text?l.push({...c,workId:n,type:p.TextUpdate,dataType:f.Local,willSyncService:!0}):l.push({...c,workId:n,type:p.UpdateNode,updateNodeOpt:{useAnimation:!1},isSync:a});return{sp:l}}}class ye extends E{constructor(){super(...arguments),u(this,"emitEventType",g.ZIndexNode)}async consume(e){const{msgType:s,dataType:t,emitEventType:r}=e;if(s===p.UpdateNode&&t===f.Local&&r===this.emitEventType)return this.consumeForLocalWorker(e),!0}async consumeForLocalWorker(e){var s;const{workId:t,updateNodeOpt:r,willRefreshSelector:o,willSyncService:a,willSerializeData:i}=e;t===T&&r&&await((s=this.localWork)==null?void 0:s.updateSelector({updateSelectorOpt:r,willRefreshSelector:o,willSyncService:a,willSerializeData:i,callback:this.updateSelectorCallback}))}updateSelectorCallback(e){const{param:s,postData:t,newServiceStore:r}=e,{willSyncService:o,isSync:a}=s,i=t.sp||[];if(o&&i)for(const[l,n]of r.entries())i.push({...n,workId:l,type:p.UpdateNode,updateNodeOpt:{useAnimation:!1},isSync:a});return{sp:i}}}class Se extends E{constructor(){super(...arguments),u(this,"emitEventType",g.TranslateNode)}async consume(e){const{msgType:s,dataType:t,emitEventType:r}=e;if(s===p.UpdateNode&&t===f.Local&&r===this.emitEventType)return await this.consumeForLocalWorker(e),!0}async consumeForLocalWorker(e){var s,t;const{workId:r,updateNodeOpt:o,willRefreshSelector:a,willSyncService:i,willSerializeData:l,textUpdateForWoker:n,emitEventType:c}=e;r===T&&o&&(o.workState===W.Done&&o!=null&&o.translate&&(o.translate[0]||o.translate[1])||o.workState!==W.Done?await((s=this.localWork)==null?void 0:s.updateSelector({updateSelectorOpt:o,willRefreshSelector:a,willSyncService:i,willSerializeData:l,isSync:!0,textUpdateForWoker:n,emitEventType:c,callback:this.updateSelectorCallback})):o.workState===W.Done&&((t=this.localWork)==null||t.vNodes.deleteLastTarget()))}updateSelectorCallback(e){const{param:s,postData:t,newServiceStore:r,workShapeNode:o,res:a}=e,{willSyncService:i,isSync:l,updateSelectorOpt:n,textUpdateForWoker:c}=s,h=n.workState,k=t.sp||[];if(h===W.Start)return{sp:[],render:[]};const d=a==null?void 0:a.selectRect;if(i){h===W.Doing&&k.push({type:p.Select,selectIds:o.selectIds,selectRect:d,willSyncService:!0,isSync:!0,points:o.getChildrenPoints(),textOpt:o.textOpt});for(const[y,v]of r.entries())c&&v.toolsType===m.Text?k.push({...v,workId:y,type:p.TextUpdate,dataType:f.Local,willSyncService:!0}):k.push({...v,workId:y,type:p.UpdateNode,updateNodeOpt:{useAnimation:!1},isSync:l})}return{sp:k}}}class ve extends E{constructor(){super(...arguments),u(this,"emitEventType",g.DeleteNode)}async consume(){return!1}}class we extends E{constructor(){super(...arguments),u(this,"emitEventType",g.ScaleNode)}async consume(e){const{msgType:s,dataType:t,emitEventType:r}=e;if(s===p.UpdateNode&&t===f.Local&&r===this.emitEventType)return await this.consumeForLocalWorker(e),!0}async consumeForLocalWorker(e){var s;const{workId:t,updateNodeOpt:r,willSyncService:o,willSerializeData:a}=e;t===T&&r&&await((s=this.localWork)==null?void 0:s.updateSelector({updateSelectorOpt:r,willSyncService:o,willSerializeData:a,isSync:!0,callback:this.updateSelectorCallback.bind(this)}))}updateSelectorCallback(e){const{param:s,postData:t,workShapeNode:r,res:o,newServiceStore:a}=e,{updateSelectorOpt:i,willSyncService:l}=s,n=i.workState,c=t.sp||[],h=o==null?void 0:o.selectRect;if(n===W.Start)return{sp:[],render:[]};if(l){c.push({type:p.Select,selectIds:r.selectIds,selectRect:h,willSyncService:!0,isSync:!0,points:n===W.Done&&r.getChildrenPoints()||void 0,textOpt:r.textOpt});for(const[k,d]of a.entries())d.toolsType===m.Text?c.push({...d,workId:k,type:p.TextUpdate,dataType:f.Local,willSyncService:!0}):c.push({...d,workId:k,type:p.UpdateNode,updateNodeOpt:{useAnimation:!1},isSync:!0})}return{sp:c}}}class fe extends E{constructor(){super(...arguments),u(this,"emitEventType",g.RotateNode)}async consume(e){const{msgType:s,dataType:t,emitEventType:r}=e;if(s===p.UpdateNode&&t===f.Local&&r===this.emitEventType)return await this.consumeForLocalWorker(e),!0}async consumeForLocalWorker(e){var s;const{workId:t,updateNodeOpt:r,willRefreshSelector:o,willSyncService:a,willSerializeData:i,emitEventType:l}=e;t===T&&r&&await((s=this.localWork)==null?void 0:s.updateSelector({updateSelectorOpt:r,willRefreshSelector:o,willSyncService:a,willSerializeData:i,emitEventType:l,isSync:!0,callback:this.updateSelectorCallback}))}updateSelectorCallback(e){const{param:s,postData:t,workShapeNode:r,res:o,newServiceStore:a}=e,{updateSelectorOpt:i,willSyncService:l,willSerializeData:n,isSync:c}=s,h=i.workState,k=t.sp||[],d=o==null?void 0:o.selectRect;if(l){n&&h===W.Done&&k.push({type:p.Select,selectIds:r.selectIds,selectRect:d,willSyncService:!0,isSync:c,points:r.getChildrenPoints()});for(const[y,v]of a.entries())k.push({...v,workId:y,type:p.UpdateNode,updateNodeOpt:{useAnimation:!1},isSync:c})}return{sp:k}}}class ge extends E{constructor(){super(...arguments),u(this,"emitEventType",g.SetFontStyle)}async consume(e){const{msgType:s,dataType:t,emitEventType:r}=e;if(s===p.UpdateNode&&t===f.Local&&r===this.emitEventType)return await this.consumeForLocalWorker(e),!0}async consumeForLocalWorker(e){var s;const{workId:t,updateNodeOpt:r,willRefreshSelector:o,willSyncService:a,willSerializeData:i,textUpdateForWoker:l}=e;t===T&&r&&await((s=this.localWork)==null?void 0:s.updateSelector({updateSelectorOpt:r,willRefreshSelector:o,willSyncService:a,willSerializeData:i,textUpdateForWoker:l,callback:this.updateSelectorCallback}))}updateSelectorCallback(e){const{param:s,postData:t,newServiceStore:r,workShapeNode:o,res:a}=e,{willSyncService:i,isSync:l,updateSelectorOpt:n,textUpdateForWoker:c}=s,h=t.sp||[],k=a==null?void 0:a.selectRect;if(i&&h){n.fontSize&&h.push({type:p.Select,selectIds:o.selectIds,selectRect:k,willSyncService:i,isSync:l,points:o.getChildrenPoints()});for(const[d,y]of r.entries())c&&y.toolsType===m.Text?h.push({...y,workId:d,type:p.TextUpdate,dataType:f.Local,willSyncService:!0}):h.push({...y,workId:d,type:p.UpdateNode,updateNodeOpt:{useAnimation:!1},isSync:l})}return{sp:h}}}class Ie extends E{constructor(){super(...arguments),u(this,"emitEventType",g.SetPoint)}async consume(e){const{msgType:s,dataType:t,emitEventType:r}=e;if(s===p.UpdateNode&&t===f.Local&&r===this.emitEventType)return this.consumeForLocalWorker(e),!0}async consumeForLocalWorker(e){var s;const{workId:t,updateNodeOpt:r,willRefreshSelector:o,willSyncService:a,willSerializeData:i,textUpdateForWoker:l}=e;t===T&&r&&await((s=this.localWork)==null?void 0:s.updateSelector({updateSelectorOpt:r,willRefreshSelector:o,willSyncService:a,emitEventType:this.emitEventType,willSerializeData:i,isSync:!0,textUpdateForWoker:l,callback:this.updateSelectorCallback}))}updateSelectorCallback(e){const{param:s,postData:t,newServiceStore:r,workShapeNode:o,res:a}=e,{willSyncService:i,isSync:l}=s,n=t.sp||[],c=a==null?void 0:a.selectRect;if(i&&n){for(const[h,k]of r.entries())n.push({...k,workId:h,type:p.UpdateNode,updateNodeOpt:{useAnimation:!1},isSync:l});n.push({type:p.Select,selectIds:o.selectIds,selectRect:c,willSyncService:i,isSync:l,points:o.getChildrenPoints()})}return{sp:n}}}class We extends E{constructor(){super(...arguments),u(this,"emitEventType",g.SetLock)}async consume(e){const{msgType:s,dataType:t,emitEventType:r}=e;if(s===p.UpdateNode&&t===f.Local&&r===this.emitEventType)return this.consumeForLocalWorker(e),!0}async consumeForLocalWorker(e){var s;const{workId:t,updateNodeOpt:r,willRefreshSelector:o,willSyncService:a,willSerializeData:i}=e;t===T&&r&&await((s=this.localWork)==null?void 0:s.updateSelector({updateSelectorOpt:r,willRefreshSelector:o,willSyncService:a,willSerializeData:i,callback:this.updateSelectorCallback}))}updateSelectorCallback(e){const{param:s,postData:t,newServiceStore:r,workShapeNode:o,res:a}=e,{willSyncService:i,isSync:l,updateSelectorOpt:n}=s,c=t.sp||[],h=a==null?void 0:a.selectRect;if(i&&c){for(const[k,d]of r.entries())c.push({...d,workId:k,type:p.UpdateNode,updateNodeOpt:{useAnimation:!1},isSync:l});c.push({isLocked:n.isLocked,selectorColor:o.selectorColor,scaleType:o.scaleType,canRotate:o.canRotate,type:p.Select,selectIds:o.selectIds,selectRect:h,willSyncService:i,isSync:l})}return{sp:c}}}class Te extends E{constructor(){super(...arguments),u(this,"emitEventType",g.SetShapeOpt)}async consume(e){const{msgType:s,dataType:t,emitEventType:r}=e;if(s===p.UpdateNode&&t===f.Local&&r===this.emitEventType)return this.consumeForLocalWorker(e),!0}async consumeForLocalWorker(e){var s;const{workId:t,updateNodeOpt:r,willRefreshSelector:o,willSyncService:a,willSerializeData:i}=e;t===T&&r&&await((s=this.localWork)==null?void 0:s.updateSelector({updateSelectorOpt:r,willRefreshSelector:o,willSyncService:a,willSerializeData:i,callback:this.updateSelectorCallback}))}updateSelectorCallback(e){const{param:s,postData:t,newServiceStore:r}=e,{willSyncService:o,isSync:a}=s,i=t.sp||[];if(o&&i)for(const[l,n]of r.entries())i.push({...n,workId:l,type:p.UpdateNode,updateNodeOpt:{useAnimation:!1},isSync:a});return{sp:i}}}class Le{constructor(e){u(this,"builders",new Map),this.builders=new Map(e.map(s=>[s,this.build(s)]))}build(e){switch(e){case g.TranslateNode:return new Se;case g.ZIndexNode:return new ye;case g.CopyNode:return new me;case g.SetColorNode:return new ke;case g.DeleteNode:return new ve;case g.ScaleNode:return new we;case g.RotateNode:return new fe;case g.SetFontStyle:return new ge;case g.SetPoint:return new Ie;case g.SetLock:return new We;case g.SetShapeOpt:return new Te}}registerForMainThread(e){return this.builders.forEach(s=>{s&&s.registerMainThread(e)}),this}async consumeForMainThread(e){for(const s of this.builders.values())if(await(s==null?void 0:s.consume(e)))return!0;return!1}}class Ne{constructor(e,s){u(this,"viewId"),u(this,"fullLayer"),u(this,"topLayer"),u(this,"localLayer"),u(this,"serviceLayer"),u(this,"snapshotFullLayer"),u(this,"vNodes"),u(this,"master"),u(this,"opt"),u(this,"cameraOpt"),u(this,"scene"),u(this,"localWork"),u(this,"serviceWork"),u(this,"topWork"),u(this,"taskUpdateCameraId"),u(this,"debounceUpdateCameraId"),u(this,"debounceUpdateCache",new Set),u(this,"mainThreadPostId"),u(this,"combinePostMsg",new Set),u(this,"methodBuilder"),u(this,"cacheImages",new Map),u(this,"imageResolveMap",new Map),this.viewId=e,this.opt=s,this.scene=this.createScene({...s.canvasOpt,container:s.container}),this.master=s.master;const t=z.bufferSize.full,r=z.bufferSize.sub;this.fullLayer=this.createLayer("fullLayer",this.scene,{...s.layerOpt,bufferSize:this.viewId===U?t:r*2}),this.topLayer=this.createLayer("topLayer",this.scene,{...s.layerOpt,bufferSize:(this.viewId,U,r),contextType:"2d"}),this.localLayer=this.createLayer("localLayer",this.scene,{...s.layerOpt,bufferSize:(this.viewId,U,r),contextType:"2d"}),this.serviceLayer=this.createLayer("serviceLayer",this.scene,{...s.layerOpt,bufferSize:(this.viewId,U,r),contextType:"2d"}),this.vNodes=new ie(e,this.scene);const o={thread:this,vNodes:this.vNodes};this.localWork=new de(o),this.serviceWork=new ue(o),this.topWork=new pe(o),this.vNodes.init(this.fullLayer),this.methodBuilder=new Le([g.CopyNode,g.SetColorNode,g.DeleteNode,g.RotateNode,g.ScaleNode,g.TranslateNode,g.ZIndexNode,g.SetFontStyle,g.SetPoint,g.SetLock,g.SetShapeOpt]).registerForMainThread(this)}getCachedImages(e){var s;return(s=this.cacheImages.get(e))==null?void 0:s.imageBitmap}getCachedImagesByWorkId(e){for(const[s,t]of this.cacheImages.entries())if(s===e&&t.imageBitmap)return t.imageBitmap}deleteCachedImagesByWorkId(e){for(const[s,t]of this.cacheImages.entries())t.workId===e&&(t.imageBitmap.close(),this.cacheImages.delete(s))}clearCacheImages(){this.cacheImages.forEach(e=>e.imageBitmap.close()),this.cacheImages.clear()}clearImageResolveMap(){this.imageResolveMap.forEach(({timer:e})=>{e&&clearTimeout(e)}),this.imageResolveMap.clear()}post(e){this.combinePostMsg.add(e),this.runBatchPostData()}updateDpr(e){this.scene.displayRatio=e}async on(e){if(!await this.methodBuilder.consumeForMainThread(e)){const{msgType:s,toolsType:t,opt:r,dataType:o,workId:a,workState:i,imageSrc:l,imageBitmap:n,workIds:c,isLockSentEventCursor:h}=e,k=a==null?void 0:a.toString();switch(s){case p.UpdateDpr:x.isNumber(e.dpr)&&this.updateDpr(e.dpr);break;case p.AuthClear:{const{clearUids:d,localUid:y}=e;this.vNodes.setCanClearUids(d),this.vNodes.setLocalUid(y);break}case p.Destroy:this.destroy();break;case p.Clear:this.clearAll();break;case p.UpdateCamera:await this.updateCamera(e);break;case p.UpdateTools:if(t&&r){const d={toolsType:t,toolsOpt:r};this.topWork.canUseTopLayer(t)?this.topWork.setToolsOpt(d):this.localWork.setToolsOpt(d)}break;case p.CreateWork:if(k&&r&&t){if(this.topWork.canUseTopLayer(t)){this.topWork.getToolsOpt()||this.topWork.setToolsOpt({toolsType:t,toolsOpt:r}),this.topWork.setWorkOptions(k,r);break}this.localWork.getToolsOpt()||this.localWork.setToolsOpt({toolsType:t,toolsOpt:r}),this.localWork.setWorkOptions(k,r)}break;case p.DrawWork:i===W.Done&&o===f.Local?(this.consumeDrawAll(o,e),t===m.LaserPen&&h&&this.post({sp:[{type:p.None,isLockSentEventCursor:h}]})):this.consumeDraw(o,e);break;case p.UpdateNode:case p.FullWork:if(t&&this.topWork.canUseTopLayer(t)){this.consumeDrawAll(o,e);break}this.consumeFull(o,e);break;case p.RemoveNode:await this.removeNode(e);return;case p.Select:o===f.Service&&(a===T?this.localWork.updateFullSelectWork(e):this.serviceWork.runSelectWork(e));break;case p.CursorBlur:this.localWork.cursorBlur();return;case p.CursorHover:this.localWork.cursorHover(e);break;case p.GetTextActive:o===f.Local&&this.localWork.checkTextActive(e);break;case p.GetImageBitMap:if(l&&n&&a){const d=a.toString();this.deleteCachedImagesByWorkId(d),this.cacheImages.set(l,{imageBitmap:n,workId:d});const y=this.imageResolveMap.get(l);if(y){const{resolve:v,timer:I}=y;I&&clearTimeout(I),v&&v(l)}}break;case p.GetVNodeInfo:if(a&&c){const d=c.map(y=>this.vNodes.get(y));this.post({sp:[{type:p.GetVNodeInfo,dataType:f.Local,workId:a,vInfo:d}]})}break}}}getIconSize(e,s,t){const r=e*t,o=s*t;return r<=50||o<=50?[50,50]:r<=100||o<=100?[100,100]:r<=200||o<=200?[200,200]:r<=400||o<=400?[400,400]:r<=800||o<=800?[800,800]:[1600,1600]}async loadImageBitMap(e){const{toolsType:s,opt:t,workId:r}=e;if(s===m.Image&&t&&r){const o=r.toString(),{src:a,type:i,width:l,height:n,strokeColor:c}=t;if(!a||!i||!l||!n)return;let h=a;if(i===ee.Iconify){const[d,y]=this.getIconSize(l,n,this.opt.displayer.dpr);h=`${a}?width=${d}&height=${y}&color=${c}`}if(this.cacheImages.has(h)){const d=this.getCachedImages(h);if(d)return d}if(this.imageResolveMap.has(h)){const d=this.getCachedImagesByWorkId(o);if(d)return d}const k=await new Promise(d=>{const y=this.imageResolveMap.get(h)||{resolve:void 0,timer:void 0};y.timer&&clearTimeout(y.timer),y.resolve=d,y.timer=setTimeout(()=>{const v=this.imageResolveMap.get(h);v!=null&&v.resolve&&v.resolve(h)},5e3),this.imageResolveMap.set(h,y),this.opt.post({sp:[{imageSrc:h,workId:o,viewId:this.viewId,isgl:!!this.fullLayer.parent.gl,isSubWorker:!1,type:p.GetImageBitMap}]})});return this.imageResolveMap.delete(k),this.getCachedImages(h)}}async removeNode(e){const{dataType:s,workId:t,removeIds:r}=e,o=r||[];if(t&&o.push(t.toString()),o.length)for(const a of o){if(a===T){await this.localWork.removeSelector(e);continue}s===f.Local?this.localWork.removeWork(e):s===f.Service&&this.serviceWork.removeWork(e),await this.localWork.colloctEffectSelectWork(e)}}async consumeFull(e,s){const t=await this.localWork.colloctEffectSelectWork(s);t&&e===f.Local&&await this.localWork.consumeFull(t),t&&e===f.Service&&this.serviceWork.consumeFull(t)}setCameraOpt(e){this.cameraOpt=e;const{scale:s,centerX:t,centerY:r,width:o,height:a}=e;(o!==this.scene.width||a!==this.scene.height)&&this.updateScene({width:o,height:a}),this.fullLayer.setAttribute("scale",[s,s]),this.fullLayer.setAttribute("translate",[-t,-r]),this.topLayer.setAttribute("scale",[s,s]),this.topLayer.setAttribute("translate",[-t,-r]),this.localLayer.setAttribute("scale",[s,s]),this.localLayer.setAttribute("translate",[-t,-r]),this.serviceLayer.setAttribute("scale",[s,s]),this.serviceLayer.setAttribute("translate",[-t,-r])}runBatchPostData(){this.mainThreadPostId||(this.mainThreadPostId=requestAnimationFrame(this.combinePost.bind(this)))}combinePostData(){var e;this.mainThreadPostId=void 0;const s=[];let t,r;for(const o of this.combinePostMsg.values()){if((e=o.sp)!=null&&e.length)for(const a of o.sp){let i=!1;for(const l of s)if(x.isEqual(a,l)){i=!0;break}i||s.push(a)}x.isNumber(o.fullWorkerDrawCount)&&(t=o.fullWorkerDrawCount),x.isNumber(o.consumeCount)&&(r=o.consumeCount)}return this.combinePostMsg.clear(),{sp:s,fullWorkerDrawCount:t,consumeCount:r}}combinePost(){var e,s;const t=this.combinePostData(),r=(e=t.sp)==null?void 0:e.filter(o=>o.type!==p.None||o.isLockSentEventCursor);r!=null&&r.length?t.sp=r.map(o=>o.viewId?o:{...o,viewId:this.viewId}):delete t.sp,t.consumeCount===void 0&&delete t.consumeCount,t.fullWorkerDrawCount===void 0&&delete t.fullWorkerDrawCount,(t!=null&&t.consumeCount||t!=null&&t.fullWorkerDrawCount||(s=t.sp)!=null&&s.length)&&this.opt.post(t)}clearAll(){this.fullLayer.children.length&&(this.fullLayer.parent.children.forEach(e=>{e.name!=="viewport"&&e.remove()}),q(this.fullLayer,this.fullLayer.parent)),this.clearCacheImages(),this.clearImageResolveMap(),this.localWork.clearAll(),this.topWork.clearAll(),this.serviceWork.clearAll(),this.vNodes.clear(),this.post({sp:[{type:p.Clear}]})}consumeDrawAll(e,s){const{toolsType:t,workId:r}=s;if(r){const o=r.toString();if(t&&this.topWork.canUseTopLayer(t)){e===f.Local&&(this.topWork.getLocalWorkShape(r.toString())||this.topWork.createLocalWork(s)),this.topWork.consumeDrawAll(s);return}e===f.Local&&(this.localWork.getWorkShape(o)||this.localWork.createLocalWork(s),this.localWork.consumeDrawAll(s,this.serviceWork))}}consumeDraw(e,s){const{opt:t,workId:r,toolsType:o}=s;if(r&&o&&t){const a=r.toString();if(this.topWork.canUseTopLayer(o)){e===f.Local&&(this.topWork.getLocalWorkShape(a)||this.topWork.createLocalWork(s)),this.topWork.consumeDraw(s);return}e===f.Local?(this.localWork.getWorkShape(a)||this.localWork.createLocalWork(s),this.localWork.consumeDraw(s,this.serviceWork)):e===f.Service&&this.serviceWork.consumeDraw(s);return}}async updateCamera(e){var s;const{cameraOpt:t,scenePath:r}=e;if(t&&!x.isEqual(this.cameraOpt,t)){if(this.taskUpdateCameraId&&(clearTimeout(this.taskUpdateCameraId),this.taskUpdateCameraId=void 0),r){let n=!1;for(const[c,h]of this.localWork.getWorkShapes().entries())switch(h.toolsType){case m.Text:case m.BitMapEraser:case m.PencilEraser:case m.Eraser:case m.Selector:case m.LaserPen:break;default:c!==B&&c!==T&&(n=!0);break}if(n){this.taskUpdateCameraId=setTimeout(()=>{this.taskUpdateCameraId=void 0,this.updateCamera(e)},Y);return}}const o=new Map;for(const[n,c]of this.vNodes.getNodesByType(m.Text).entries()){const h=c.rect;o.set(n,x.cloneDeep(h))}const a=new Set(o.keys());let i=!1;if(this.localWork.hasSelector()){const n=(s=this.localWork.getSelector())==null?void 0:s.selectIds;if(n){i=!0;for(const c of n)a.add(c)}}let l=!1;if(this.serviceWork.selectorWorkShapes.size)for(const n of this.serviceWork.selectorWorkShapes.values()){const c=n.selectIds;if(c){l=!0;for(const h of c)a.add(h)}}if(this.setCameraOpt(t),this.vNodes.curNodeMap.size){this.vNodes.clearTarget(),this.vNodes.updateHighLevelNodesRect(a),this.debounceUpdateCameraId&&clearTimeout(this.debounceUpdateCameraId);for(const[n,c]of o.entries()){const h=this.vNodes.get(n);if(h){const k=c,d=h.rect,y=this.getSceneRect(),v=V(k,y),I=V(d,y);let w=!1;if((v!==I||k.w!==d.w||k.h!==d.h||I===Q.intersect)&&(w=!0),w){const{toolsType:b,opt:F}=h;b===m.Text&&F.workState===W.Done&&this.debounceUpdateCache.add(n)}}}if(i&&this.localWork.reRenderSelector(),l)for(const[n,c]of this.serviceWork.selectorWorkShapes.entries())this.serviceWork.runSelectWork({workId:n,selectIds:c.selectIds,msgType:p.Select,dataType:f.Service,viewId:this.viewId});this.debounceUpdateCameraId=setTimeout(()=>{var n;this.debounceUpdateCameraId=void 0;const c=[];for(const h of this.debounceUpdateCache.values()){if((n=this.fullLayer)!=null&&n.getElementsByName(h)[0]){const k=this.vNodes.get(h);if(k){const{toolsType:d,opt:y,rect:v}=k,I=this.localWork.setFullWork({toolsType:d,opt:y,workId:h});if(I){const w=this.getSceneRect(),b=V(v,w);c.push(I.consumeServiceAsync({isFullWork:!0,replaceId:h,isDrawLabel:b!==Q.outside}))}}}this.debounceUpdateCache.delete(h)}this.vNodes.updateLowLevelNodesRect(),this.vNodes.clearHighLevelIds()},Y)}}}getSceneRect(){const{width:e,height:s}=this.scene;return{x:0,y:0,w:Math.floor(e),h:Math.floor(s)}}createScene(e){return new te({displayRatio:this.opt.displayer.dpr,depth:!1,desynchronized:!0,...e,autoRender:!0,id:this.viewId,contextType:"2d"})}createLayer(e,s,t){const{width:r,height:o}=t,a=`canvas-${e}`,i=s.layer(a,{...t,offscreen:!1}),l=new se({anchor:[.5,.5],pos:[r*.5,o*.5],size:[r,o],name:"viewport",id:e});return i.append(l),l}updateScene(e){this.scene.attr({...e});const{width:s,height:t}=e;this.scene.width=s,this.scene.height=t,this.updateLayer({width:s,height:t})}updateLayer(e){const{width:s,height:t}=e;this.fullLayer.parent.setAttribute("width",s),this.fullLayer.parent.setAttribute("height",t),this.fullLayer.setAttribute("size",[s,t]),this.fullLayer.setAttribute("pos",[s*.5,t*.5]),this.topLayer.parent.setAttribute("width",s),this.topLayer.parent.setAttribute("height",t),this.topLayer.setAttribute("size",[s,t]),this.topLayer.setAttribute("pos",[s*.5,t*.5]),this.localLayer.parent.setAttribute("width",s),this.localLayer.parent.setAttribute("height",t),this.localLayer.setAttribute("size",[s,t]),this.localLayer.setAttribute("pos",[s*.5,t*.5]),this.serviceLayer.parent.setAttribute("width",s),this.serviceLayer.parent.setAttribute("height",t),this.serviceLayer.setAttribute("size",[s,t]),this.serviceLayer.setAttribute("pos",[s*.5,t*.5])}destroy(){this.clearCacheImages(),this.clearImageResolveMap(),this.vNodes.clear(),this.fullLayer.remove(),A(this.fullLayer,this.fullLayer.parent),this.topLayer.remove(),A(this.topLayer,this.topLayer.parent),this.localLayer.remove(),A(this.localLayer,this.localLayer.parent),this.serviceLayer.remove(),A(this.serviceLayer,this.serviceLayer.parent),this.scene.remove(),this.localWork.destroy(),this.serviceWork.destroy(),this.topWork.destroy()}}class Ce{constructor(e,s){u(this,"viewId"),u(this,"fullLayer"),u(this,"master"),u(this,"opt"),u(this,"scene"),u(this,"mainThreadPostId"),u(this,"combinePostMsg",new Set),u(this,"workShapes",new Map),u(this,"cacheImages",new Map),u(this,"imageResolveMap",new Map),this.viewId=e,this.opt=s,this.scene=this.createScene({...s.canvasOpt,container:s.container}),this.master=s.master,this.fullLayer=this.createLayer("fullLayer",this.scene,{...s.layerOpt,bufferSize:this.viewId===U?6e3:3e3,contextType:"2d"})}getCachedImages(e){var s;return(s=this.cacheImages.get(e))==null?void 0:s.imageBitmap}getCachedImagesByWorkId(e){for(const[s,t]of this.cacheImages.entries())if(s===e&&t.imageBitmap)return t.imageBitmap}deleteCachedImagesByWorkId(e){for(const[s,t]of this.cacheImages.entries())t.workId===e&&(t.imageBitmap.close(),this.cacheImages.delete(s))}clearCacheImages(){this.cacheImages.forEach(e=>e.imageBitmap.close()),this.cacheImages.clear()}clearImageResolveMap(){this.imageResolveMap.forEach(({timer:e})=>{e&&clearTimeout(e)}),this.imageResolveMap.clear()}post(e){this.combinePostMsg.add(e),this.runBatchPostData()}async on(e){const{msgType:s,imageSrc:t,imageBitmap:r,workId:o}=e;switch(s){case p.Snapshot:await this.getSnapshot(e),this.destroy();return;case p.BoundingBox:await this.getBoundingRect(e),this.destroy();return;case p.GetImageBitMap:if(t&&r&&o){const a=o.toString();this.deleteCachedImagesByWorkId(a),this.cacheImages.set(t,{imageBitmap:r,workId:a});const i=this.imageResolveMap.get(t);if(i){const{resolve:l,timer:n}=i;n&&clearTimeout(n),l&&l(t)}}break}}getIconSize(e,s,t){const r=e*t,o=s*t;return r<=50||o<=50?[50,50]:r<=100||o<=100?[100,100]:r<=200||o<=200?[200,200]:r<=400||o<=400?[400,400]:r<=800||o<=800?[800,800]:[1600,1600]}async loadImageBitMap(e){const{toolsType:s,opt:t,workId:r}=e;if(s===m.Image&&t&&r){const o=r.toString(),{src:a,type:i,width:l,height:n,strokeColor:c}=t;if(!a||!i||!l||!n)return;let h=a;if(i===ee.Iconify){const[d,y]=this.getIconSize(l,n,this.opt.displayer.dpr);h=`${a}?width=${d}&height=${y}&color=${c}`}if(this.cacheImages.has(h)){const d=this.getCachedImages(h);if(d)return d}if(this.imageResolveMap.has(h)){const d=this.getCachedImagesByWorkId(o);if(d)return d}const k=await new Promise(d=>{const y=this.imageResolveMap.get(h)||{resolve:void 0,timer:void 0};y.timer&&clearTimeout(y.timer),y.resolve=d,y.timer=setTimeout(()=>{const v=this.imageResolveMap.get(h);v!=null&&v.resolve&&v.resolve(h)},5e3),this.imageResolveMap.set(h,y),this.opt.post({sp:[{imageSrc:h,workId:o,viewId:this.viewId,isgl:!!this.fullLayer.parent.gl,isSubWorker:!0,type:p.GetImageBitMap}]})});return this.imageResolveMap.delete(k),this.getCachedImages(h)}}createWorkShapeNode(e){return H({...e,fullLayer:this.fullLayer,drawLayer:void 0})}setFullWork(e){const{workId:s,opt:t,toolsType:r}=e;if(s&&t&&r){const o=s.toString();let a;return s&&this.workShapes.has(o)?(a=this.workShapes.get(o),a==null||a.setWorkOptions(t)):a=this.createWorkShapeNode({toolsOpt:t,toolsType:r,workId:o}),a?(this.workShapes.set(o,a),a):void 0}}async runFullWork(e){var s;const t=this.setFullWork(e),r=e.ops&&$(e.ops);if(t){let o,a;const i=(s=t.getWorkId())==null?void 0:s.toString();return t.toolsType===m.Image?o=await t.consumeServiceAsync({isFullWork:!0,worker:this}):t.toolsType===m.Text?o=await t.consumeServiceAsync({isFullWork:!0,replaceId:i,isDrawLabel:!0}):(o=t.consumeService({op:r,isFullWork:!0,replaceId:i}),a=(e==null?void 0:e.updateNodeOpt)&&t.updataOptService(e.updateNodeOpt)),Z(o,a)}}async getSnapshot(e){const{scenePath:s,scenes:t,cameraOpt:r,w:o,h:a}=e;if(s&&t&&r){this.setCameraOpt(r);let i;for(const[n,c]of Object.entries(t))if(c!=null&&c.type)switch(c==null?void 0:c.type){case p.UpdateNode:case p.FullWork:{const{opt:h}=c,k={...c,opt:h,workId:n,msgType:p.FullWork,dataType:f.Service,viewId:this.viewId},d=await this.runFullWork(k);i=Z(i,d);break}}let l;o&&a&&(l={resizeWidth:o,resizeHeight:a}),await this.getSnapshotRender({scenePath:s,options:l})}}getSceneRect(){const{width:e,height:s}=this.scene;return{x:0,y:0,w:Math.floor(e),h:Math.floor(s)}}getRectImageBitmap(e,s){const t=Math.floor(e.x*this.opt.displayer.dpr),r=Math.floor(e.y*this.opt.displayer.dpr),o=e.w>0&&Math.floor(e.w*this.opt.displayer.dpr||1)||1,a=e.h>0&&Math.floor(e.h*this.opt.displayer.dpr||1)||1;return createImageBitmap(this.fullLayer.parent.canvas,t,r,o,a,s)}async getSnapshotRender(e){var s;const{scenePath:t,options:r}=e;((s=this.fullLayer)==null?void 0:s.parent).render();const o=await this.getRectImageBitmap(this.getSceneRect(),r);o&&(this.post({sp:[{type:p.Snapshot,scenePath:t,imageBitmap:o,viewId:this.viewId}]}),this.fullLayer&&q(this.fullLayer,this.fullLayer.parent))}async getBoundingRect(e){const{scenePath:s,scenes:t,cameraOpt:r}=e;if(s&&t&&r){this.setCameraOpt(r);let o;for(const[a,i]of Object.entries(t))if(i!=null&&i.type)switch(i==null?void 0:i.type){case p.UpdateNode:case p.FullWork:{const l=await this.runFullWork({...i,workId:a,msgType:p.FullWork,dataType:f.Service,viewId:this.viewId});o=Z(o,l);break}}o&&this.post({sp:[{type:p.BoundingBox,scenePath:s,rect:o}]})}}setCameraOpt(e){const{scale:s,centerX:t,centerY:r,width:o,height:a}=e;this.updateScene({width:o,height:a}),this.fullLayer.setAttribute("scale",[s,s]),this.fullLayer.setAttribute("translate",[-t,-r])}runBatchPostData(){this.mainThreadPostId||(this.mainThreadPostId=requestAnimationFrame(this.combinePost.bind(this)))}combinePostData(){var e;this.mainThreadPostId=void 0;const s=[];for(const t of this.combinePostMsg.values())if((e=t.sp)!=null&&e.length)for(const r of t.sp){let o=!1;for(const a of s)if(le(r,a)){o=!0;break}o||s.push(r)}return this.combinePostMsg.clear(),{sp:s}}combinePost(){var e,s;const t=this.combinePostData(),r=(e=t.sp)==null?void 0:e.filter(o=>o.type!==p.None||o.isLockSentEventCursor);r!=null&&r.length?t.sp=r.map(o=>o.viewId?o:{...o,viewId:this.viewId}):delete t.sp,(s=t.sp)!=null&&s.length&&this.opt.post(t)}createScene(e){return new te({displayRatio:this.opt.displayer.dpr,depth:!1,desynchronized:!0,...e,autoRender:!1,contextType:"2d"})}createLayer(e,s,t){const{width:r,height:o}=t,a=`canvas-${e}`,i=s.layer(a,t),l=new se({anchor:[.5,.5],pos:[r*.5,o*.5],size:[r,o],name:"viewport",id:e});return i.append(l),l}updateScene(e){this.scene.attr({...e});const{width:s,height:t}=e;this.scene.width=s,this.scene.height=t,this.updateLayer({width:s,height:t})}updateLayer(e){const{width:s,height:t}=e;this.fullLayer.parent.setAttribute("width",s),this.fullLayer.parent.setAttribute("height",t),this.fullLayer.setAttribute("size",[s,t]),this.fullLayer.setAttribute("pos",[s*.5,t*.5])}destroy(){this.clearCacheImages(),this.clearImageResolveMap(),this.fullLayer.remove(),A(this.fullLayer,this.fullLayer.parent),this.scene.remove()}}class Oe{constructor(e){u(this,"mainThreadMap",new Map),u(this,"snapshotThread"),u(this,"master"),this.master=e}post(e){const{fullWorkerDrawCount:s,sp:t,workerTasksqueueCount:r,consumeCount:o}=e;this.master.isBusy&&K(r)&&this.master.setWorkerTasksqueueCount(r),K(s)&&this.master.setMaxDrawCount(s),K(o)&&this.master.setConsumeCount(o),t&&this.master.collectorSyncData(t)}destroy(){this.mainThreadMap.clear()}createMainThread(e,s){return new Ne(e,s)}createSnapshotThread(e,s){return new Ce(e,s)}async consume(e){var s,t,r,o;for(const a of e.values()){const{msgType:i,viewId:l,tasksqueue:n,mainTasksqueueCount:c,layerOpt:h,offscreenCanvasOpt:k,cameraOpt:d,isSubWorker:y}=a;if(i===p.Console){console.log(this);continue}if(i===p.Init){const I=(s=this.master.control.viewContainerManager.getView(l))==null?void 0:s.displayer,w=I==null?void 0:I.canvasContainerRef.current;if(I&&w&&h&&k){const b=this.createMainThread(l,{displayer:I,container:w,layerOpt:h,master:this.master,canvasOpt:k,post:this.post.bind(this)});this.mainThreadMap.set(l,b),b&&d&&b.setCameraOpt(d)}continue}if((i===p.Snapshot||i===p.BoundingBox)&&l===((t=this.master.control.viewContainerManager.mainView)==null?void 0:t.id)){const I=(r=this.master.control.viewContainerManager.getView(l))==null?void 0:r.displayer,w=(o=I.snapshotContainerRef)==null?void 0:o.current;if(I&&w&&d){w.style.width=`${d.width}px`,w.style.height=`${d.height}px`;const b={...X.defaultLayerOpt,offscreen:!1,width:d.width,height:d.height},F={...X.defaultScreenCanvasOpt,width:d.width,height:d.height};this.snapshotThread=this.createSnapshotThread(l,{displayer:I,container:w,layerOpt:b,master:this.master,canvasOpt:F,post:this.post.bind(this)}),this.snapshotThread.on(a).then(()=>{this.snapshotThread=void 0,w.innerHTML="",w.style.width="",w.style.height=""});continue}}if(i===p.GetImageBitMap&&y&&this.snapshotThread){this.snapshotThread.on(a);continue}if(i===p.TasksQueue&&n!=null&&n.size){for(const[I,w]of this.mainThreadMap.entries()){const b=n.get(I);b&&(await w.on(b),c&&this.post({workerTasksqueueCount:c}))}continue}if(l===ae){for(const I of this.mainThreadMap.values())I.on(a),i===p.Destroy&&this.mainThreadMap.delete(l);continue}const v=this.mainThreadMap.get(l);v&&(v.on(a),i===p.Destroy&&this.mainThreadMap.delete(l))}}}export{Oe as MainThreadManagerImpl};
